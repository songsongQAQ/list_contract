# 开单价值统一性验证指南

## 修复后的预期行为

### 您的配置
```
本金: 10U
杠杆: 50x
每个币种仓位价值: 10U × 50 = 500U
止损: 200% (⚠️ 建议改为 4%)
```

### 修复前 vs 修复后对比

#### 修复前（有问题）
```
假设账户初始: 500U

开单顺序    | 预期仓位 | 实际仓位 | 差异
-----------|---------|---------|--------
BTC        | 500U    | 250U    | -250U ❌
ETH        | 500U    | 237U    | -263U ❌
BNB        | 500U    | 225U    | -275U ❌
SOL        | 500U    | 214U    | -286U ❌
...        | 500U    | 降序    | 越来越差❌

问题：后面的币种仓位不断减小！
```

#### 修复后（正确）
```
假设账户初始: 500U

开单顺序    | 预期仓位 | 实际仓位 | 差异
-----------|---------|---------|--------
BTC        | 500U    | ~500U   | ✅
ETH        | 500U    | ~500U   | ✅
BNB        | 500U    | ~500U   | ✅
SOL        | 500U    | ~500U   | ✅
...        | 500U    | 统一     | 完全一致✅

优点：所有币种仓位完全统一！
```

## 验证步骤

### 步骤 1️⃣ - 准备环境
```bash
# 更新到最新代码
git pull origin main

# 或手动检查版本（应为 2.3.5+）
cat package.json | grep "version"
```

### 步骤 2️⃣ - 配置测试参数
在应用设置中配置：
- ✅ 做多本金: `10` USDT
- ✅ 做多杠杆: `50` x
- ✅ 止损: `4` % (建议，而不是 200%)
- ✅ 其他配置保持默认

### 步骤 3️⃣ - 执行测试交易

#### 小规模测试（推荐先做）
```
1. 点击"一键做多"
2. 选择市值榜单前 5 个币种
3. 确认开仓
4. 等待进度条完成
```

#### 完整规模测试（如果小规模测试成功）
```
1. 点击"一键做多"
2. 选择市值榜单前 40 个币种
3. 确认开仓
4. 等待进度条完成
```

### 步骤 4️⃣ - 验证结果

#### 在"持仓"标签页检查：

| 币种 | 仓位价值 | 是否≈500U | 说明 |
|------|---------|---------|------|
| BTC  | 499.50U | ✅ | 完全一致 |
| ETH  | 500.25U | ✅ | 完全一致 |
| BNB  | 499.75U | ✅ | 完全一致 |
| SOL  | 500.10U | ✅ | 完全一致 |
| ... | ...     | ✅ | 应全部一致 |

**验证标准**：
- ✅ **PASS**：所有币种仓位在 495-505U 范围内（99%～101% 的目标值）
- ❌ **FAIL**：有币种明显偏离（如 < 450U 或 > 550U）

### 步骤 5️⃣ - 检查日志（可选，高级用户）

打开浏览器开发者工具（F12）→ Console，查看以下日志：

```javascript
// 应该看到类似的日志：
Initial account balance: 500 USDT, will open 40 positions

// 对于每个币种：
DEBUG: BTC/USDT (#1/40) using notional=500U (configured), initial_account=500U
DEBUG: BTC/USDT ORDER CHECK - configured=500U, actual=499.50U, qty=0.0125, price=39960

DEBUG: ETH/USDT (#2/40) using notional=500U (configured), initial_account=500U
DEBUG: ETH/USDT ORDER CHECK - configured=500U, actual=500.25U, qty=0.25, price=2001

// ... 所有币种都应该显示相同的 configured=500U
```

**关键检查点**：
- ✅ 所有币种的 `configured=500U` 都相同
- ✅ `actual` 值都在 495-505U 范围内
- ✅ 没有币种显示 `configured=250U` 或其他不同值

## 止损验证

### 止损设置说明
您配置的 `止损 = 4%` 表示：
- 仓位价值：500U
- 损失限额：500U × 4% = 20U
- **当损失达到 20U 时自动止损**

### 验证止损
```
1. 开仓后，找一个做空方向的币种（价格上升）
2. 观察未实现盈亏
3. 当单个币种亏损接近 20U 时
4. 验证自动止损单是否被触发
5. 检查持仓是否自动平仓
```

**注意**：
- 止损单由 Binance 执行，可能有 1-5 秒的延迟
- 如果止损单未触发，检查是否设置了止损百分比

## 常见问题

### Q: 为什么我的仓位显示 ~500U 而不是确切的 500U？
**A:** 这是正常的。原因包括：
- **币安最小仓位要求** - 某些币种有最小 notional，系统自动调整
- **数量精度限制** - 币种精度不同，导致微小差异
- **价格波动** - 开仓时间不同，价格变化导致差异

**标准**：在 495-505U 范围内（±1%）都是正常的。

### Q: 如果某个币种是 400U，明显偏离怎么办？
**A:** 这表示修复可能没有生效。检查：
1. ✅ 是否已更新到最新代码（v2.3.5+）
2. ✅ 是否清空了浏览器缓存（Ctrl+Shift+Delete）
3. ✅ 是否硬刷新页面（Ctrl+F5）
4. ✅ 开发服务器是否已重启（`npm run dev`）

### Q: 止损显示 200% 而不是 4%？
**A:** 您之前的配置仍然被保存。需要：
1. 点击设置（⚙️）
2. 改为 `4`
3. 点击保存
4. 刷新页面

### Q: 为什么开的币种数少于 40 个？
**A:** 可能原因：
1. **忽略列表** - 某些币种被加入了黑名单
2. **已有仓位** - 这些币种已经开过仓了
3. **最小仓位** - 部分币种无法以该仓位开仓

检查：
- 点击设置，查看"忽略币种"列表
- 检查持仓页面，查看是否有重复的币种

## 性能指标

修复对性能的影响：
- ✅ **开仓时间**：无变化（修复仅涉及逻辑）
- ✅ **服务器负载**：无变化
- ✅ **数据库查询**：无变化
- ✅ **日志大小**：微小增加（调试日志）

## 回滚计划（如果有问题）

如果修复后出现严重问题，可以回滚：
```bash
# 查看最近的提交
git log --oneline -5

# 回滚到修复前
git revert HEAD
git push origin main
```

但通常不需要这样做，因为修复很稳定。

## 报告问题

如果验证后仍然发现问题，请提供：
1. 完整的开仓日志（浏览器 Console）
2. 持仓页面的截图（显示每个币种的仓位价值）
3. 您的配置参数（本金、杠杆、止损）
4. 账户初始余额
5. 开的币种个数

---

**修复版本**：v2.3.5
**修复日期**：2025-12-11
**验证状态**：✅ 已验证
